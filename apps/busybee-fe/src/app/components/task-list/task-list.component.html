<div class="flex min-h-screen bg-base-100">
  <!-- Sidebar -->
  <app-sidebar
    [projects]="projects()"
    [taskStats]="taskStats()"
    [filterType]="filterType()"
    [priorityFilter]="priorityFilter()"
    [dateFilter]="dateFilter()"
    [projectFilter]="projectFilter()"
    [isSidebarOpen]="isSidebarOpen()"
    (resetFilters)="resetAllFilters()"
    (filterChanged)="onFilterChanged($event)"
    (sidebarClosed)="closeSidebar()"
    (projectModalOpened)="openProjectModal()"
    (projectDeleted)="onDeleteProject($event.project, $event.event)"
  />

  <!-- Main Content -->
  <main class="flex-1 lg:ml-64 flex flex-col transition-all duration-300">
    <!-- Header -->
    <app-header
      [filterType]="filterType()"
      [priorityFilter]="priorityFilter()"
      [searchQuery]="searchQuery()"
      [isDarkMode]="isDarkMode()"
      (sidebarToggled)="toggleSidebar()"
      (searchChanged)="onSearchChange($event)"
      (themeToggled)="toggleTheme()"
      (createTask)="onCreateTask()"
    />

    <!-- Error Alert -->
    @if (error()) {
    <div class="alert alert-error mx-4 lg:mx-12 mt-6 max-w-5xl">
      <svg
        class="w-6 h-6"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <circle cx="12" cy="12" r="10" />
        <path d="M12 8v4M12 16h.01" stroke-linecap="round" />
      </svg>
      <span>{{ error() }}</span>
      <button class="btn btn-ghost btn-sm btn-circle" (click)="error.set(null)">
        <svg
          class="w-4 h-4"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" />
        </svg>
      </button>
    </div>
    }

    <!-- Task List Container -->
    <div class="flex-1 px-4 lg:px-12 py-6 max-w-5xl">
      @if (loading()) {
      <!-- Loading State - Skeleton -->
      <div class="space-y-4">
        @for (item of [1, 2, 3, 4, 5]; track item) {
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <div class="flex items-start gap-3">
              <!-- Checkbox skeleton -->
              <div class="skeleton w-5 h-5 rounded shrink-0 mt-0.5"></div>
              <div class="flex-1 space-y-3">
                <!-- Title skeleton -->
                <div class="skeleton h-4 w-3/4"></div>
                <!-- Description skeleton -->
                <div class="skeleton h-3 w-full"></div>
                <div class="skeleton h-3 w-5/6"></div>
                <!-- Tags and metadata skeleton -->
                <div class="flex gap-2 items-center">
                  <div class="skeleton h-6 w-16 rounded-full"></div>
                  <div class="skeleton h-6 w-20 rounded-full"></div>
                  <div class="skeleton h-4 w-24"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        }
      </div>
      } @else if (filteredTasks().length === 0) {
      <!-- Empty State -->
      <div
        class="flex flex-col items-center justify-center py-20 text-center px-4"
      >
        @if (searchQuery() || filterType() !== 'all' || priorityFilter() !==
        'all') {
        <svg
          class="w-20 h-20 text-base-content/15 mb-5"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" stroke-linecap="round" />
        </svg>
        <h3 class="text-lg font-semibold text-base-content mb-1.5">
          No tasks found
        </h3>
        <p class="text-sm text-base-content/50 mb-5">
          Try adjusting your filters or search query
        </p>
        <button
          class="btn btn-ghost btn-sm normal-case"
          (click)="
            searchQuery.set(''); setFilter('all'); setPriorityFilter('all')
          "
        >
          Clear filters
        </button>
        } @else {
        <svg
          class="w-20 h-20 text-base-content/15 mb-5"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
          <path d="M9 11h6M12 8v6" stroke-linecap="round" />
        </svg>
        <h3 class="text-lg font-semibold text-base-content mb-1.5">
          No tasks yet
        </h3>
        <p class="text-sm text-base-content/50 mb-5">
          Get organized by creating your first task
        </p>
        <button
          class="btn btn-sm btn-neutral gap-1.5 normal-case"
          (click)="onCreateTask()"
        >
          <svg
            class="w-4 h-4"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
          >
            <path d="M12 5v14M5 12h14" stroke-linecap="round" />
          </svg>
          Add task
        </button>
        }
      </div>
      } @else {
      <!-- Task List -->
      <ul class="space-y-2 mb-8">
        @for (task of filteredTasks(); track trackByTaskId($index, task)) {
        <app-task-card
          [task]="task"
          (taskToggled)="onTaskToggled($event)"
          (taskEdited)="onTaskEdited($event)"
          (taskDeleted)="onTaskDeleted($event)"
        />
        }
      </ul>
      }
    </div>
  </main>
</div>

<!-- Task Form Modal -->
<app-task-form-modal
  [isOpen]="isModalOpen()"
  [task]="editingTask()"
  [projectId]="defaultProjectId()"
  (closed)="onModalClosed()"
  (taskSubmitted)="onTaskSubmitted($event)"
/>

<!-- Project Form Modal -->
<app-project-form-modal
  [isOpen]="isProjectModalOpen()"
  (closed)="onProjectModalClosed()"
  (projectCreated)="onProjectCreated()"
/>

<!-- Delete Confirmation Modal -->
@if (isDeleteModalOpen()) {
<div class="modal modal-open">
  <div class="modal-box bg-base-100 border border-base-content/10">
    <h3 class="font-bold text-lg text-error flex items-center gap-2">
      <svg
        class="w-6 h-6"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
      Delete Task
    </h3>
    <p class="py-4 text-base-content/80">
      Are you sure you want to delete "<span
        class="font-semibold text-base-content"
        >{{ taskToDelete()?.title }}</span
      >"?
      <br />
      <span class="text-sm text-base-content/60 mt-2 block"
        >This action cannot be undone.</span
      >
    </p>
    <div class="modal-action">
      <button class="btn btn-ghost" (click)="closeDeleteModal()">Cancel</button>
      <button class="btn btn-error" (click)="confirmDelete()">
        Delete Task
      </button>
    </div>
  </div>
  <button
    class="modal-backdrop bg-base-300/50 backdrop-blur-sm cursor-default"
    (click)="closeDeleteModal()"
  >
    close
  </button>
</div>
}

<!-- Delete Project Confirmation Modal -->
@if (isDeleteProjectModalOpen()) {
<div class="modal modal-open">
  <div class="modal-box bg-base-100 border border-base-content/10">
    <h3 class="font-bold text-lg text-error flex items-center gap-2">
      <svg
        class="w-6 h-6"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
      Delete Project
    </h3>
    <p class="py-4 text-base-content/80">
      Are you sure you want to delete the project "<span
        class="font-semibold text-base-content"
        >{{ projectToDelete()?.name }}</span
      >"?
      <br />
      <span class="text-sm text-error/80 mt-2 block font-medium"
        >⚠️ Warning: All tasks in this project will also be deleted!</span
      >
      <span class="text-sm text-base-content/60 mt-1 block"
        >This action cannot be undone.</span
      >
    </p>
    <div class="modal-action">
      <button class="btn btn-ghost" (click)="closeDeleteProjectModal()">
        Cancel
      </button>
      <button class="btn btn-error" (click)="confirmDeleteProject()">
        Delete Project
      </button>
    </div>
  </div>
  <button
    class="modal-backdrop bg-base-300/50 backdrop-blur-sm cursor-default"
    (click)="closeDeleteProjectModal()"
  >
    close
  </button>
</div>
}
